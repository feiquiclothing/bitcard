<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BitCard</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    body { background:#fff; color:#B6B6B6; font-family:monospace; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; text-align:center; }
    #logo { width:80%; max-width:400px; height:auto; margin-top:-20px; }
    .count { font-size:2em; margin:5px 0; }
    #info-principal { margin-top:10px; margin-bottom:20px; }
    #circuloImagen { max-height:200px; max-width:200px; margin:10px 0 20px; }
    .mensaje { color:#B6B6B6; font-size:14px; opacity:0; transition:opacity .5s; }
    .visible { opacity:1; }
    @keyframes glowPulse { 0%,100%{filter:drop-shadow(0 0 15px #e0e0e0)} 50%{filter:drop-shadow(0 0 25px #ffffff)} }
    .circulo-posthuman { animation:glowPulse 2.3s infinite ease-in-out; }
    #linkFeiqui { display:none; margin-top:10px; font-size:16px; color:#b6b6b6; text-decoration:none; }
    #debug { position:fixed; bottom:10px; left:10px; right:10px; max-height:40vh; overflow:auto; background:rgba(0,0,0,.7); color:#0f0; font:12px/1.3 monospace; padding:8px; border-radius:8px; display:none; text-align:left; }
    #debug h3 { margin:0 0 6px 0; color:#fff; }
    #debug pre { white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <img id="logo" src="https://cdn.shopify.com/s/files/1/0550/5001/0810/files/Feiqui_80_x_25_cm_80_x_2_cm_25_x_35_cm_300_x_300_px_750_x_750_px_0a127bcc-eff4-460a-aa46-251eca4ab8c6.png?v=1750866051" alt="Logo" />

  <div id="info-principal">
    <h1 id="clienteId">ID:</h1>
    <h1 id="nombre">SUJETO:</h1>
    <h1 id="circulo">CÍRCULO:</h1>
  </div>

  <img id="circuloImagen" src="" alt="" />

  <div class="count">Bits canjeables: <strong id="Bits">0</strong></div>
  <div class="count">Bits históricos: <strong id="BitsHistoricos">0</strong></div>
  <p id="mensajeBits" class="mensaje">+50 bits</p>

  <div class="count">Visitas: <strong id="Visitas">0</strong></div>
  <p id="mensajeVisita" class="mensaje">+1 visita</p>

  <div class="count">Ranking: <strong id="Ranking">-</strong></div>

  <a id="linkFeiqui" href="https://feiqui.com/pages/info">ir a feiqui.com</a>

  <div id="debug"><h3>DEBUG</h3><pre id="dbgpre"></pre></div>

<script>
(function(){
  // === CONFIG ===
  var qs       = new URLSearchParams(location.search);
  var API_URL  = "https://script.google.com/macros/s/AKfycbzllIFMrfGNVTe--zw_EhWSeJ6E7kodaN5X42sncu9t2nZ6a5fvaaB9K5KNFE5yaAe7HQ/exec";
  var SECRET   = "111";

  if (window.__BITCARD_RUNNING__) return;
  window.__BITCARD_RUNNING__ = true;

  var rawId    = qs.get("id");
  var authParam= qs.get("auth");  // seguimos leyendo 'auth' desde la URL
  var force    = (qs.get("force") === "1");
  var debugOn  = (qs.get("debug") === "1");
  var id       = rawId ? rawId.toString().padStart(3,"0") : "";

  function fmt(n){ var num = Number(n); return Number.isFinite(num) ? num.toLocaleString("es-UY") : "0"; }
  function num(v, d){ var n = Number(v); return Number.isFinite(n) ? n : (d||0); }
  function logDbg(obj){
    if (!debugOn) return;
    var el = document.getElementById('debug');
    var pre= document.getElementById('dbgpre');
    el.style.display='block';
    pre.textContent += (typeof obj==='string'?obj:JSON.stringify(obj, null, 2)) + "\n";
    console.log(obj);
  }

  if (!id) { document.getElementById("nombre").textContent = "Falta ?id"; return; }
  document.getElementById("clienteId").textContent = "ID: " + id;

  // PING (GET)
  var pingURL = API_URL + "?action=ping&_=" + Date.now();
  logDbg({API_URL, ping_url: pingURL});
  fetch(pingURL)
    .then(r => { logDbg({ping_status:r.status}); return r.json().catch(()=>null); })
    .then(j => logDbg({ping_body:j}))
    .catch(err => logDbg({ping_error:String(err)}));

  // PERFIL (GET)
  var perfilURL = API_URL + "?id=" + encodeURIComponent(id) + "&_=" + Date.now();
  logDbg({perfil_url: perfilURL});
  fetch(perfilURL, { cache:"no-store" })
    .then(res => { logDbg({perfil_status:res.status}); return res.json(); })
    .then(async function(data){
      logDbg({perfil_json:data});

      var deferEventURL  = null, deferEventType = null;

      // redirect por hoja si NO hay auth
      if (authParam !== SECRET && data && data.redireccion && data.url) {
        location.href = data.url; return;
      }

      var c = Array.isArray(data) ? data[0] : data;
      if (!c || !c.ID) { document.getElementById("nombre").textContent = "NO ENCONTRADO"; return; }

      // identidad
      document.getElementById("nombre").textContent  = "SUJETO: " + (c.Nombre || "-");
      document.getElementById("Ranking").textContent = (c.Ranking != null ? c.Ranking : "-");

      // círculo
      var varianteCirculo = {"CÍRCULO 1":"1","PRIMER CÍRCULO":"1","1":"1","CÍRCULO 2":"2","SEGUNDO CÍRCULO":"2","2":"2","CÍRCULO 3":"3","TERCER CÍRCULO":"3","3":"3","CÍRCULO 4":"4","CUARTO CÍRCULO":"4","4":"4","CÍRCULO 5":"5","QUINTO CÍRCULO":"5","5":"5"};
      var nombresCirculo  = {"1":"CÍRCULO 1","2":"CÍRCULO 2","3":"CÍRCULO 3","4":"CÍRCULO 4","5":"CÍRCULO 5"};
      var imagenesPorCirculo = {
        "1":"https://cdn.shopify.com/s/files/1/0550/5001/0810/files/descarga1.svg?v=1751840844",
        "2":"https://cdn.shopify.com/s/files/1/0550/5001/0810/files/descarga2.svg?v=1751840844",
        "3":"https://cdn.shopify.com/s/files/1/0550/5001/0810/files/descarga3.svg?v=1751840844",
        "4":"https://cdn.shopify.com/s/files/1/0550/5001/0810/files/descarga4.svg?v=1751840844",
        "5":"https://cdn.shopify.com/s/files/1/0550/5001/0810/files/descarga5.svg?v=1751840844"
      };
      var key = varianteCirculo[(c.Círculo || "").toString().toUpperCase().trim()] || "1";
      document.getElementById("circulo").textContent = "CÍRCULO: " + nombresCirculo[key];
      var imgEl = document.getElementById("circuloImagen");
      imgEl.src = imagenesPorCirculo[key] || "";
      imgEl.classList.toggle("circulo-posthuman", key === "3");

      // valores
      var bitsDisponibles = num(c.bits_disponibles, num(c.Bits, 0));
      var bitsHistoricos  = num(c.bits_totales_historicos, num(c.bits_totales, num(c.Bits, 0)));
      document.getElementById("Bits").textContent           = fmt(bitsDisponibles);
      document.getElementById("BitsHistoricos").textContent = fmt(bitsHistoricos);
      document.getElementById("Visitas").textContent        = fmt(c.Visitas);

      // eventos.json (opcional; admite urls_por_circulo)
      try {
        var evRes  = await fetch("data/eventos.json?nocache=" + Date.now(), { cache:"no-store" });
        logDbg({eventos_status: evRes.status});
        if (evRes.ok) {
          var ev = await evRes.json();
          logDbg({eventos_json: ev});
          if (ev && ev.evento_activo) {
            var urlEvento = (ev.urls_por_circulo && ev.urls_por_circulo[key]) || ev.url;
            if (urlEvento) {
              if (authParam === SECRET) { deferEventURL = urlEvento; deferEventType = ev.tipo || "link"; }
              else {
                if (ev.tipo === "redirect") { location.href = urlEvento; return; }
                else { var a = document.getElementById("linkFeiqui"); a.href = urlEvento; a.style.display = "inline-block"; }
              }
            }
          }
        }
      } catch(e){ logDbg({eventos_error:String(e)}); }

      // cooldown 2h
      var lastKey   = "ultimaAcreditacion_" + id;
      var lastUp    = localStorage.getItem(lastKey);
      var canUpdate = !lastUp || (Date.now() - Date.parse(lastUp)) > 2*60*60*1000;
      logDbg({canUpdate, lastUp, force});

      // si no corresponde acreditar, no llamamos al backend
      if (!(authParam === SECRET && (canUpdate || force))) {
        logDbg("SKIP acreditación (cooldown o sin auth)");
      } else {
        // === VISITA +50: POST (alias a,k) ===
        try {
          // 1) touch (POST) con alias
          var touchBody = new URLSearchParams({ a:"t", id:c.ID, k:authParam });
          logDbg({touch_post:true});
          var touchRes  = await fetch(API_URL, { method:"POST", body: touchBody, cache:"no-store" });
          logDbg({touch_status: touchRes.status});
          var touchJson = await touchRes.json().catch(()=>null);
          logDbg({touch_json: touchJson});
          if (!touchRes.ok || !touchJson || !touchJson.ok) throw new Error("touch_failed");

          var nuevasVisitas = (typeof touchJson.visitas === "number") ? touchJson.visitas : num(c.Visitas, 0) + 1;
          document.getElementById("Visitas").textContent = fmt(nuevasVisitas);
          document.getElementById("mensajeVisita").classList.add("visible");

          // 2) +50 local
          bitsDisponibles += 50; bitsHistoricos += 50;
          document.getElementById("Bits").textContent           = fmt(bitsDisponibles);
          document.getElementById("BitsHistoricos").textContent = fmt(bitsHistoricos);
          document.getElementById("mensajeBits").classList.add("visible");

          // 3) update (POST, alias a=u)
          var updBody = new URLSearchParams({
            a:"u", ID:c.ID, Nombre:c.Nombre||"", Bits:bitsDisponibles,
            Ranking:(c.Ranking!=null?c.Ranking:""), Círculo:(c.Círculo!=null?c.Círculo:"")
          });
          fetch(API_URL, { method:"POST", body: updBody })
            .then(r => logDbg({update_status:r.status}))
            .catch(e => logDbg({update_error:String(e)}));

          // 4) log (POST, alias a=l)
          var logBody = new URLSearchParams({ a:"l", ID:c.ID, Nombre:c.Nombre||"", Incremento:50 });
          fetch(API_URL, { method:"POST", body: logBody })
            .then(r => logDbg({log_status:r.status}))
            .catch(e => logDbg({log_error:String(e)}));

          // feedback + sello
          setTimeout(function(){
            document.getElementById("mensajeVisita").classList.remove("visible");
            document.getElementById("mensajeBits").classList.remove("visible");
          }, 3000);
          localStorage.setItem(lastKey, new Date().toISOString());

        } catch (e) {
  // 2) Fallback GET alias (a=t&k=...)
  try {
    logDbg({touch_error:String(e), fallback:"GET touch"});
    var touchURL = API_URL + "?" + new URLSearchParams({ a:"t", id:c.ID, k:authParam, _:Date.now() }).toString();
    logDbg({touch_get_url: touchURL});
    var r  = await fetch(touchURL, { cache:"no-store", credentials:"omit" });
    logDbg({touch_get_status: r.status});
    var j  = await r.json().catch(()=>null);
    logDbg({touch_get_json: j});

    // ¿Devolvió perfil en lugar de {ok:true}? (backend sin alias)
    if (r.ok && j && j.ok === undefined && j.Visitas !== undefined) {
      logDbg({touch_get_profile_shape:true, fallback:"LEGACY action=visit"});

      // 2.b) Fallback LEGACY: ?action=visit&id=&auth=
      var legacyURL = API_URL + "?" + new URLSearchParams({
        action:"visit", id:c.ID, auth:authParam, _:Date.now()
      }).toString();
      logDbg({legacy_visit_url: legacyURL});
      var r2  = await fetch(legacyURL, { cache:"no-store", credentials:"omit" });
      logDbg({legacy_visit_status: r2.status});
      var j2  = await r2.json().catch(()=>null);
      logDbg({legacy_visit_json: j2});
      if (!r2.ok || !j2 || !j2.ok) throw new Error("legacy_visit_failed");

      var nuevasVisitasL = (typeof j2.visitas === "number") ? j2.visitas : num(c.Visitas,0)+1;
      document.getElementById("Visitas").textContent = fmt(nuevasVisitasL);
      document.getElementById("mensajeVisita").classList.add("visible");

      bitsDisponibles += 50; bitsHistoricos += 50;
      document.getElementById("Bits").textContent           = fmt(bitsDisponibles);
      document.getElementById("BitsHistoricos").textContent = fmt(bitsHistoricos);
      document.getElementById("mensajeBits").classList.add("visible");

      // update/log por POST alias (si el backend nuevo ya está, suma; si no, lo ignora sin romper)
      var updBodyL = new URLSearchParams({
        a:"u", ID:c.ID, Nombre:c.Nombre||"", Bits:bitsDisponibles,
        Ranking:(c.Ranking!=null?c.Ranking:""), Círculo:(c.Círculo!=null?c.Círculo:"")
      });
      fetch(API_URL, { method:"POST", body: updBodyL, credentials:"omit" })
        .then(r3 => logDbg({update_status_legacy:r3.status}))
        .catch(e3 => logDbg({update_error_legacy:String(e3)}));

      var logBodyL = new URLSearchParams({ a:"l", ID:c.ID, Nombre:c.Nombre||"", Incremento:50 });
      fetch(API_URL, { method:"POST", body: logBodyL, credentials:"omit" })
        .then(r4 => logDbg({log_status_legacy:r4.status}))
        .catch(e4 => logDbg({log_error_legacy:String(e4)}));

      setTimeout(function(){
        document.getElementById("mensajeVisita").classList.remove("visible");
        document.getElementById("mensajeBits").classList.remove("visible");
      }, 3000);
      localStorage.setItem("ultimaAcreditacion_"+id, new Date().toISOString());
      return; // listo ✅
    }

    // Si NO es el caso “perfil”, exigimos ok:true como siempre
    if (!r.ok || !j || !j.ok) throw new Error("touch_get_failed");

    // --- Camino OK del GET alias a=t ---
    var nuevasVisitas = (typeof j.visitas === "number") ? j.visitas : num(c.Visitas, 0) + 1;
    document.getElementById("Visitas").textContent = fmt(nuevasVisitas);
    document.getElementById("mensajeVisita").classList.add("visible");

    bitsDisponibles += 50; bitsHistoricos += 50;
    document.getElementById("Bits").textContent           = fmt(bitsDisponibles);
    document.getElementById("BitsHistoricos").textContent = fmt(bitsHistoricos);
    document.getElementById("mensajeBits").classList.add("visible");

    var updBody2 = new URLSearchParams({
      a:"u", ID:c.ID, Nombre:c.Nombre||"", Bits:bitsDisponibles,
      Ranking:(c.Ranking!=null?c.Ranking:""), Círculo:(c.Círculo!=null?c.Círculo:"")
    });
    fetch(API_URL, { method:"POST", body: updBody2, credentials:"omit" }).then(r2 => logDbg({update_status:r2.status}));

    var logBody2 = new URLSearchParams({ a:"l", ID:c.ID, Nombre:c.Nombre||"", Incremento:50 });
    fetch(API_URL, { method:"POST", body: logBody2, credentials:"omit" }).then(r2 => logDbg({log_status:r2.status}));

    localStorage.setItem("ultimaAcreditacion_"+id, new Date().toISOString());

  } catch (e2) {
    // 3) Fallback final: no-cors + beacon + img (optimista)
    logDbg({acreditacion_error:String(e2), fallback:"no-cors+beacon+img"});
    try {
      var bodyNC = new URLSearchParams({ a:"t", id:c.ID, k:authParam });
      await fetch(API_URL, { method:"POST", mode:"no-cors", body: bodyNC, credentials:"omit" });
      logDbg({touch_nocors_sent:true});
    } catch(_){}

    try {
      if (navigator.sendBeacon) {
        var fd = new FormData();
        fd.append('a','t'); fd.append('id', c.ID); fd.append('k', authParam);
        navigator.sendBeacon(API_URL, fd);
        logDbg({touch_beacon_sent:true});
      }
    } catch(_){}

    try {
      var img = new Image();
      img.src = API_URL + "?" + new URLSearchParams({ a:"t", id:c.ID, k:authParam, img:1, _:Date.now() }).toString();
      logDbg({touch_img_fired:true});
    } catch(_){}

    // UI optimista y sello local
    var nv = num(c.Visitas, 0) + 1;
    document.getElementById("Visitas").textContent = fmt(nv);
    document.getElementById("mensajeVisita").classList.add("visible");
    bitsDisponibles += 50; bitsHistoricos += 50;
    document.getElementById("Bits").textContent           = fmt(bitsDisponibles);
    document.getElementById("BitsHistoricos").textContent = fmt(bitsHistoricos);
    document.getElementById("mensajeBits").classList.add("visible");
    setTimeout(function(){
      document.getElementById("mensajeVisita").classList.remove("visible");
      document.getElementById("mensajeBits").classList.remove("visible");
    }, 3000);
    localStorage.setItem("ultimaAcreditacion_"+id, new Date().toISOString());
  }
}


      // redirects diferidos si hay auth
      if (authParam === SECRET) {
        if (data && data.redireccion && data.url) { location.href = data.url; return; }
        if (deferEventURL) {
          if (deferEventType === "redirect") { location.href = deferEventURL; return; }
          else { var a2 = document.getElementById("linkFeiqui"); a2.href = deferEventURL; a2.style.display = "inline-block"; }
        }
      }

      // link por defecto
      if (document.getElementById("linkFeiqui").style.display !== "inline-block") {
        document.getElementById("linkFeiqui").style.display = "inline-block";
      }
    })
    .catch(function(err){
      console.error("BitCard error:", err);
      document.getElementById("nombre").textContent = "Error cargando datos";
    });
})();
</script>
</body>
</html>
