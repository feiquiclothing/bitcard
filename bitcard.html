<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BitCard</title>
<style>
  body{font-family:monospace;background:#fff;color:#666;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;text-align:center}
  .count{font-size:2em;margin:6px 0}
  .msg{opacity:0;transition:opacity .4s;color:#888}
  .msg.show{opacity:1}
  #debug{position:fixed;left:10px;right:10px;bottom:10px;max-height:40vh;overflow:auto;background:#000b;color:#0f0;padding:8px;border-radius:8px;display:none;text-align:left;font:12px/1.3 monospace}
  #debug pre{white-space:pre-wrap;margin:0}
</style>
</head>
<body>
  <h1 id="id">ID:</h1>
  <div class="count">Bits: <b id="bits">0</b></div>
  <div class="count">Visitas: <b id="visitas">0</b></div>
  <div class="msg" id="mbits">+50 bits</div>
  <div class="msg" id="mvis">+1 visita</div>
  <div id="debug"><pre id="dbg"></pre></div>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const API = "https://script.google.com/macros/s/AKfycbynqoZHnauSW8BZL9qbygNhx91Ja1-aLNF14X92wa0udO4tGugE0kFyVBO1JNbczaAmYw/exec"; // <- ACTUALIZA si redeployás
  const id  = (qs.get('id')||'').toString().padStart(3,'0');
  const k   = qs.get('auth') || '';
  const force = qs.get('force') === '1';
  const debug = qs.get('debug') === '1';
  const $ = s => document.querySelector(s);
  const log = x => { if(!debug) return; $('#debug').style.display='block'; $('#dbg').textContent += (typeof x==='string'?x:JSON.stringify(x,null,2))+"\n"; console.log(x); };
  const fmt = n => Number(n||0).toLocaleString('es-UY');

  if (!id || id==='000') { $('#id').textContent='Falta ?id'; return; }
  $('#id').textContent = 'ID: ' + id;

  async function perfil() {
    const url = API + "?" + new URLSearchParams({ id, _:Date.now() });
    log({perfil_url:url});
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json(); log({perfil_json:j});
    return j;
  }
  async function apply() {
    const url = API + "?" + new URLSearchParams({ a:'apply', id, k, _:Date.now() });
    log({apply_url:url});
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json(); log({apply_json:j});
    return j;
  }
  async function visit() {
    const url = API + "?" + new URLSearchParams({ a:'v', id, k, _:Date.now() });
    log({visit_url:url});
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json(); log({visit_json:j});
    return j;
  }
  async function setBitsAbs(nuevo) {
    const url = API + "?" + new URLSearchParams({ a:'u', ID:id, Bits:String(nuevo), k, _:Date.now() });
    log({absbits_url:url});
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json(); log({absbits_json:j});
    return j;
  }
  function flash(id){ const el=$(id); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }

  // Perfil inicial
  const p0 = await perfil();
  if (!p0 || !p0.ok) { $('#id').textContent='ID no encontrado'; return; }
  let bits = Number(p0.bits_disponibles ?? p0.Bits ?? 0);
  let vis  = Number(p0.Visitas ?? 0);
  $('#bits').textContent = fmt(bits);
  $('#visitas').textContent = fmt(vis);

  // Cooldown 2h
  const kLC = 'bc_last_'+id;
  const last = localStorage.getItem(kLC);
  const can = !last || (Date.now()-Date.parse(last)) > 2*60*60*1000;

  if (k && (can || force)) {
    // 1) apply
    try {
      const a = await apply();
      if (a && a.ok && a.updated) {
        if (typeof a.bits === 'number') bits = a.bits;
        if (typeof a.visitas === 'number') vis = a.visitas;
        $('#bits').textContent = fmt(bits);
        $('#visitas').textContent = fmt(vis);
        flash('#mbits'); flash('#mvis');
        localStorage.setItem(kLC, new Date().toISOString());
      } else {
        // 2) fallback: visita + set bits absolutos
        await visit();
        await setBitsAbs(bits + 50);
        const p1 = await perfil();
        bits = Number(p1.bits_disponibles ?? p1.Bits ?? (bits+50));
        vis  = Number(p1.Visitas ?? (vis+1));
        $('#bits').textContent = fmt(bits);
        $('#visitas').textContent = fmt(vis);
        flash('#mbits'); flash('#mvis');
        localStorage.setItem(kLC, new Date().toISOString());
      }
    } catch (err) {
      log({error:String(err)});
    }
  } else {
    log('SKIP acreditación (sin auth o cooldown)');
  }
})();
</script>
</body>
</html>
